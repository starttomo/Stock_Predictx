<!DOCTYPE html>
<html>
<head>
    <title>沪深300 量化分析系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        /* 交易相关样式 */
        .trade-tabs { display: flex; margin-bottom: 15px; }
        .tab-btn {
            padding: 8px 16px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab-btn.active { background: #1e40af; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .trade-form { display: flex; gap: 10px; flex-wrap: wrap; }
        .trade-form input { flex: 1; min-width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        .btn-buy { background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .btn-sell { background: #16a34a; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .btn-buy:hover { background: #b91c1c; }
        .btn-sell:hover { background: #15803d; }

        .btn-strategy, .btn-forecast, .btn-simulate {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            width: calc(100% - 10px);
            text-align: center;
            display: block;
            text-decoration: none;
        }
        .btn-strategy:hover, .btn-forecast:hover, .btn-simulate:hover { background: #6d28d9; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            position: relative;
        }
        .close {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
        }
        .close:hover { color: #000; }

        #order-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success-message { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .error-message { background: #fee2e2; color: #dc2626; border: 1px solid #ef4444; }

        /* 策略结果样式 */
        #strategy-result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        .analysis-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        .analysis-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .analysis-section h4 {
            margin: 0 0 8px 0;
            color: #1e40af;
            font-size: 14px;
        }
        .analysis-section p {
            margin: 0;
            font-size: 13px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>沪深300 量化分析系统</h1>
        <div class="user-info">
            <span>欢迎, {{ current_user.username }}</span>
            <a href="{{ url_for('profile') }}">个人中心</a>
            <a href="{{ url_for('logout') }}">登出</a>
        </div>
    </div>

    <div class="main-layout">
        <!-- 左侧：K线图 -->
        <div class="chart-panel">
            <div class="chart-header">
                <h2>最新收盘价: <span id="current-price">{{ "%.2f"|format(current_price) }}</span></h2>
                <select id="timeframe" onchange="changeTimeframe()">
                    <option value="day">日线</option>
                    <option value="week">周线</option>
                    <option value="month">月线</option>
                </select>
            </div>
            <div id="chart" style="height: 600px; width: 100%;"></div>
        </div>

        <!-- 右侧：操作面板 -->
        <div class="control-panel">
            <!-- 持仓信息 -->
            <div class="section">
                <h3>持仓信息</h3>
                <div id="portfolio-info">
                    <p>加载中...</p>
                </div>
            </div>

            <!-- 策略展示 -->
            <div class="section">
                <button class="btn-strategy" onclick="toggleStrategy()" id="btn-strategy">生成交易策略</button>
                <div id="strategy-result"></div>
            </div>

            <!-- 未来预测 -->
            <div class="section">
                <button class="btn-forecast" onclick="showForecast()">查看未来预测</button>
            </div>

            <!-- 模拟交易入口 -->
            <div class="section">
                <a href="{{ url_for('simulate_trade') }}" class="btn-simulate">进入模拟交易</a>
            </div>
        </div>
    </div>
</div>

<!-- 预测模态框 -->
<div id="forecast-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeForecastModal()">×</span>
        <h3>未来5日预测</h3>
        <div id="forecast-chart" style="height: 400px;"></div>
        <div id="forecast-table"></div>
    </div>
</div>

<script>
// === 数据准备 ===
const rawData = {{ data|tojson }};
let data = rawData.map(d => ({
    ...d,
    date: new Date(d.date),
    ma7: d.ma7 ? parseFloat(d.ma7) : null,
    ma30: d.ma30 ? parseFloat(d.ma30) : null,
    upper: d.upper ? parseFloat(d.upper) : null,
    mid: d.mid ? parseFloat(d.mid) : null,
    lower: d.lower ? parseFloat(d.lower) : null
}));

// === ECharts 初始化 ===
const chart = echarts.init(document.getElementById('chart'));
let timeframe = 'day';

// === 切换时间周期 ===
function changeTimeframe() {
    timeframe = document.getElementById('timeframe').value;
    renderChart();
}

// === 渲染图表 ===
function renderChart() {
    let grouped = {};
    data.forEach(d => {
        let key, open, high, low, close;
        if (timeframe === 'day') {
            key = d.date.toISOString().split('T')[0];
            open = d.open; high = d.high; low = d.low; close = d.close;
        } else if (timeframe === 'week') {
            const week = Math.ceil(d.date.getDate() / 7);
            key = `${d.date.getFullYear()}-W${week}`;
            if (!grouped[key]) grouped[key] = { o: d.open, h: d.high, l: d.low, c: d.close };
            else {
                grouped[key].h = Math.max(grouped[key].h, d.high);
                grouped[key].l = Math.min(grouped[key].l, d.low);
                grouped[key].c = d.close;
            }
            return;
        } else {
            key = `${d.date.getFullYear()}-${d.date.getMonth() + 1}`;
            if (!grouped[key]) grouped[key] = { o: d.open, h: d.high, l: d.low, c: d.close };
            else {
                grouped[key].h = Math.max(grouped[key].h, d.high);
                grouped[key].l = Math.min(grouped[key].l, d.low);
                grouped[key].c = d.close;
            }
            return;
        }
        if (!grouped[key]) grouped[key] = { o: open, h: high, l: low, c: close };
        else {
            grouped[key].h = Math.max(grouped[key].h, high);
            grouped[key].l = Math.min(grouped[key].l, low);
            grouped[key].c = close;
        }
    });

    const dates = Object.keys(grouped);
    const kdata = dates.map(k => [grouped[k].o, grouped[k].c, grouped[k].l, grouped[k].h]);

    const ma7 = [], ma30 = [], boll = { upper: [], mid: [], lower: [] };
    data.forEach(d => {
        const idx = dates.indexOf(d.date.toISOString().split('T')[0]);
        if (idx !== -1) {
            ma7[idx] = d.ma7;
            ma30[idx] = d.ma30;
            boll.upper[idx] = d.upper;
            boll.mid[idx] = d.mid;
            boll.lower[idx] = d.lower;
        }
    });

    chart.setOption({
        tooltip: { trigger: 'axis' },
        legend: { data: ['K线', 'MA7', 'MA30', 'BOLL上轨', 'BOLL中轨', 'BOLL下轨'] },
        xAxis: { type: 'category', data: dates },
        yAxis: { type: 'value' },
        dataZoom: [{ type: 'inside' }, { type: 'slider' }],
        series: [
            { name: 'K线', type: 'candlestick', data: kdata },
            { name: 'MA7', type: 'line', data: ma7, lineStyle: { color: '#ff9900' }, showSymbol: false },
            { name: 'MA30', type: 'line', data: ma30, lineStyle: { color: '#3399ff' }, showSymbol: false },
            { name: 'BOLL上轨', type: 'line', data: boll.upper, lineStyle: { color: '#c23531' }, showSymbol: false },
            { name: 'BOLL中轨', type: 'line', data: boll.mid, lineStyle: { color: '#2f4554' }, showSymbol: false },
            { name: 'BOLL下轨', type: 'line', data: boll.lower, lineStyle: { color: '#61a0a8' }, showSymbol: false }
        ]
    }, true);
}

// === 持仓信息 ===
async function updatePortfolio() {
    try {
        const response = await fetch('/portfolio');
        const portfolio = await response.json();

        const portfolioDiv = document.getElementById('portfolio-info');
        portfolioDiv.innerHTML = `
            <p><strong>现金:</strong> ￥${portfolio.cash.toFixed(2)}</p>
            <p><strong>持仓:</strong> ${portfolio.position} 股</p>
            <p><strong>股票市值:</strong> ￥${portfolio.stock_value.toFixed(2)}</p>
            <p><strong>总资产:</strong> ￥${portfolio.total_value.toFixed(2)}</p>
            <p><strong>当前价格:</strong> ￥${portfolio.current_price.toFixed(2)}</p>
        `;
    } catch (error) {
        console.error('更新持仓失败:', error);
    }
}

// === 策略展开/收起 ===
let strategyExpanded = false;

function toggleStrategy() {
    const resultDiv = document.getElementById('strategy-result');
    const button = document.getElementById('btn-strategy');

    if (strategyExpanded) {
        // 收起策略
        resultDiv.style.display = 'none';
        button.textContent = '生成交易策略';
        strategyExpanded = false;
    } else {
        // 展开策略
        getAnalysis();
        button.textContent = '收起交易策略';
        strategyExpanded = true;
    }
}

// === 获取策略分析 ===
async function getAnalysis() {
    try {
        const response = await fetch('/get_analysis');
        if (!response.ok) {
            const errorText = await response.text();
            alert('获取分析失败: ' + errorText);
            return;
        }
        const data = await response.json();
        if (!data.success) {
            alert(data.message || "分析失败");
            return;
        }
        renderAnalysis(data.analysis);
    } catch (error) {
        alert('获取分析失败: ' + error);
    }
}
// === 渲染策略分析 ===
function renderAnalysis(analysis) {
    const resultDiv = document.getElementById('strategy-result');
    resultDiv.innerHTML = `
        <div class="analysis-section">
            <h4>当前分析</h4>
            <p>${analysis.current_analysis}</p>
        </div>
        <div class="analysis-section">
            <h4>未来策略</h4>
            <p>${analysis.future_strategy}</p>
        </div>
        <div class="analysis-section">
            <h4>风险评估</h4>
            <p>${analysis.risk}</p>
        </div>
        <div class="analysis-section">
            <h4>预期回报</h4>
            <p>${analysis.expected_return !== undefined && analysis.expected_return !== null ? analysis.expected_return.toFixed(2) : "N/A"}%</p>
        </div>
    `;
    resultDiv.style.display = 'block';
}


// === 获取未来预测 ===
async function showForecast() {
    try {
        console.log('开始获取预测数据...');
        const response = await fetch('/get_forecast');
        const data = await response.json();
        console.log('获取到的预测数据:', data);

        if (data.future_data && data.future_data.length > 0) {
            renderForecastChart(data.future_data);
            renderForecastTable(data.future_data);
            document.getElementById('forecast-modal').style.display = 'block';
        } else {
            alert('没有获取到预测数据');
        }
    } catch (error) {
        console.error('获取预测失败:', error);
        alert('获取预测失败: ' + error);
    }
}

function renderForecastChart(forecastData) {
    console.log('渲染预测图表，数据:', forecastData);

    const forecastChart = echarts.init(document.getElementById('forecast-chart'));

    // 确保数据格式正确
    const dates = forecastData.map(d => {
        // 处理日期格式，确保是字符串格式
        if (d.date instanceof Date) {
            return d.date.toISOString().split('T')[0];
        }
        return d.date.split(' ')[0]; // 去掉时间部分，只保留日期
    });

    const yhat = forecastData.map(d => parseFloat(d.yhat) || 0);
    const yhatLower = forecastData.map(d => parseFloat(d.yhat_lower) || 0);
    const yhatUpper = forecastData.map(d => parseFloat(d.yhat_upper) || 0);

    console.log('处理后的数据 - 日期:', dates);
    console.log('处理后的数据 - 预测值:', yhat);

    const option = {
        title: {
            text: '沪深300未来5日价格预测',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                let result = params[0].name + '<br/>';
                params.forEach(param => {
                    result += `${param.seriesName}: ${param.value.toFixed(2)}<br/>`;
                });
                return result;
            }
        },
        legend: {
            data: ['预测价格', '置信区间'],
            top: '10%'
        },
        xAxis: {
            type: 'category',
            data: dates,
            axisLabel: {
                rotate: 45
            }
        },
        yAxis: {
            type: 'value',
            name: '价格',
            scale: true
        },
        grid: {
            top: '20%',
            bottom: '15%'
        },
        series: [
            {
                name: '预测价格',
                type: 'line',
                data: yhat,
                lineStyle: {
                    color: '#1890ff',
                    width: 3
                },
                itemStyle: {
                    color: '#1890ff'
                },
                symbol: 'circle',
                symbolSize: 6
            },
            {
                name: '置信区间',
                type: 'line',
                data: yhatUpper,
                lineStyle: {
                    opacity: 0.5,
                    color: '#91cc75'
                },
                areaStyle: {
                    color: 'rgba(144, 238, 144, 0.3)'
                },
                symbol: 'none',
                smooth: true
            },
            {
                name: '置信区间',
                type: 'line',
                data: yhatLower,
                lineStyle: {
                    opacity: 0.5,
                    color: '#91cc75'
                },
                areaStyle: {
                    color: 'rgba(144, 238, 144, 0.3)'
                },
                symbol: 'none',
                smooth: true
            }
        ]
    };

    forecastChart.setOption(option);

    // 确保图表正确渲染
    setTimeout(() => {
        forecastChart.resize();
    }, 100);
}

function renderForecastTable(forecastData) {
    console.log('渲染预测表格，数据:', forecastData);

    let tableHtml = `
        <div style="margin-top: 20px;">
            <h4>详细预测数据</h4>
            <table style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <tr style="background: #1e40af; color: white;">
                    <th style="padding: 10px; text-align: left;">日期</th>
                    <th style="padding: 10px; text-align: left;">预测价格</th>
                    <th style="padding: 10px; text-align: left;">置信下限</th>
                    <th style="padding: 10px; text-align: left;">置信上限</th>
                </tr>
    `;

    forecastData.forEach(item => {
        const dateStr = item.date instanceof Date ?
            item.date.toISOString().split('T')[0] :
            item.date.split(' ')[0];

        tableHtml += `
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px;">${dateStr}</td>
                <td style="padding: 10px; color: #1890ff; font-weight: bold;">${parseFloat(item.yhat).toFixed(2)}</td>
                <td style="padding: 10px; color: #52c41a;">${parseFloat(item.yhat_lower).toFixed(2)}</td>
                <td style="padding: 10px; color: #f5222d;">${parseFloat(item.yhat_upper).toFixed(2)}</td>
            </tr>
        `;
    });

    tableHtml += '</table></div>';
    document.getElementById('forecast-table').innerHTML = tableHtml;
}

function closeForecastModal() {
    document.getElementById('forecast-modal').style.display = 'none';
}

// === 页面初始化 ===
document.addEventListener('DOMContentLoaded', function() {
    updatePortfolio();
    // 每30秒自动更新持仓
    setInterval(updatePortfolio, 30000);
});

// 初始化图表
renderChart();
</script>
</body>
</html>